<!DOCTYPE html>
<html>
<head>
    <title>Stock Browser</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        h1 {
            text-align: center;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination button {
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>Stock Browser</h1>

    <table>
        <thead>
            <tr>
                <th>Ticker</th>
                <th>Market Cap</th>
                <th>Net Income</th>
                <th>Basic EPS</th>
            </tr>
        </thead>
        <tbody id="stocksTableBody">
            <!-- The data will be populated using JavaScript -->
        </tbody>
    </table>

    <div class="pagination" id="pagination">
        <!-- The pagination buttons will be populated using JavaScript -->
    </div>

    <script>
 var ticker_list = [];
    var ticker_xhr = new XMLHttpRequest();
    ticker_xhr.open('GET', '/tickers');
    ticker_xhr.onreadystatechange = function() {
        if (ticker_xhr.readyState === XMLHttpRequest.DONE) {
            if (ticker_xhr.status === 200) {
                ticker_list = JSON.parse(ticker_xhr.responseText);
                // Initial setup: display first page and generate pagination buttons
                updateTable(1);
                generatePaginationButtons();
            }
        }
    };
    ticker_xhr.send();

    // Function to update the table with stock data
    function updateTable(pageNumber) {
        var tableBody = document.getElementById("stocksTableBody");
        tableBody.innerHTML = ""; // Clear existing rows

        var itemsPerPage = 25;
        var startIndex = (pageNumber - 1) * itemsPerPage;
        var endIndex = Math.min(startIndex + itemsPerPage, ticker_list.length);

        // Create a closure to preserve the value of 'i'
        function processStockData(i) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', `/stock/${ticker_list[i]}`);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        var responseData = JSON.parse(xhr.responseText);
                        var stockName = ticker_list[i];
                        var marketCap = responseData["market_cap"];
                        var row = `<tr>
                                    <td>${stockName}</td>
                                    <td>${marketCap}</td>
                                    <td>${responseData["net_income"]}</td>
                                    <td>${responseData["basic_eps"]}</td>
                                </tr>`;
                        tableBody.innerHTML += row;
                    }
                }
            };
            xhr.send();
        }

        // Loop through the tickers and call processStockData for each
        for (var i = startIndex; i < endIndex; i++) {
            processStockData(i);
        }
    }

    // Function to generate pagination buttons
    function generatePaginationButtons() {
        var paginationContainer = document.getElementById("pagination");
        paginationContainer.innerHTML = ""; // Clear existing buttons

        var totalPages = Math.ceil(ticker_list.length / 25);
        for (var i = 1; i <= totalPages; i++) {
            var button = document.createElement("button");
            button.innerText = i;
            button.addEventListener("click", function() {
                var pageNumber = parseInt(this.innerText);
                updateTable(pageNumber);
            });
            paginationContainer.appendChild(button);
        }
    }
    </script>
</body>
</html>
