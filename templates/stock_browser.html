<!DOCTYPE html>
<html>
<head>
    <title>Stock Browser</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        h1 {
            text-align: center;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination button {
            margin: 5px;
        }
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            background-color: #f7f9f6;
            transition: opacity 0.75s, visibility 0.75s;
        }
        .loader-hidden{
            opacity: 0;
            visibility: hidden;
        }
        .loader::after{
            content: "";
            width: 75px;
            height: 75px;
            border: 15px solid #dddddd;
            border-top-color: #7449f5;
            border-radius: 50%;
            animation: loading 0.75s ease infinite;
        }
        @keyframes loading {
            from{
                transform: rotate(0turn);
            }
            to{
                transform: rotate(1turn);
            }
        }

    </style>
</head>
<body>
    <h1>Stock Browser</h1>
{#    <div class="loader" id="loader"></div>#}
    <table>
        <thead>
            <tr>
                <th class="text-center">Ticker</th>
                <th class="text-center">Market Cap</th>
                <th class="text-center">Net Income</th>
                <th class="text-center">Basic EPS</th>
            </tr>
        </thead>
        <tbody id="stocksTableBody">
            <!-- The data will be populated using JavaScript -->
        </tbody>
    </table>

    <div class="pagination" id="pagination">
        <!-- The pagination buttons will be populated using JavaScript -->
    </div>
<script>
    var ticker_list = [];
    var ticker_xhr = new XMLHttpRequest();
    ticker_xhr.open('GET', '/tickers');
    ticker_xhr.onreadystatechange = function() {
        if (ticker_xhr.readyState === XMLHttpRequest.DONE) {
            if (ticker_xhr.status === 200) {
                ticker_list = JSON.parse(ticker_xhr.responseText);
                // Initial setup: display first page and generate pagination buttons
                updateTable(1);
                generatePaginationButtons(1);
            }
        }
    };
    ticker_xhr.send();
    // Function to update the table with stock data
    function updateTable(pageNumber) {
        var tableBody = document.getElementById("stocksTableBody");
        tableBody.innerHTML = ""; // Clear existing rows

        var itemsPerPage = 25;
        var startIndex = (pageNumber - 1) * itemsPerPage;
        var endIndex = Math.min(startIndex + itemsPerPage, ticker_list.length);

        var completedRequests = 0; // to keep track of completed requests

        // Create a closure to preserve the value of 'i'
        function processStockData(i) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', `/stock/${ticker_list[i]}`);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        var responseData = JSON.parse(xhr.responseText);
                        var row = `<tr style="text-align:center">
                                    <td>${ticker_list[i]}</td>
                                    <td>${responseData["market_cap"]}</td>
                                    <td>${responseData["net_income"]}</td>
                                    <td>${responseData["basic_eps"]}</td>
                                </tr>`;
                        tableBody.innerHTML += row;
                    }
                    completedRequests++; // increment count of completed requests
                }
            };
            xhr.send();
        }

{#    document.getElementById("loader").style.display = "block"; // show loader#}
    generatePaginationButtons(pageNumber);
    // Loop through the tickers and call processStockData for each
    for (var i = startIndex; i < endIndex; i++) {
        processStockData(i);
    }
{#    document.ajaxStop(function() {#}
{#    const loader = document.querySelector(".loader");#}
{#    loader.classList.add("loader-hidden");#}
{#    loader.addEventListener("transitioned", () => {#}
{#        document.body.removeChild("loader");#}
{#    })#}
{# });  #}
}

    // Function to generate pagination buttons
    function generatePaginationButtons(currentPage) {
        var paginationContainer = document.getElementById("pagination");
        paginationContainer.innerHTML = ""; // Clear existing buttons

        var totalPages = Math.ceil(ticker_list.length / 25);
        var maxPage = Math.min(currentPage + 2, totalPages);
        var start_page = Math.max(currentPage - 2, 1);
        for (var i = start_page; i <= maxPage; i++) {
            var button = document.createElement("button");
            button.innerText = i;
            button.addEventListener("click", function() {
                var pageNumber = parseInt(this.innerText);
                updateTable(pageNumber);
            });
            paginationContainer.appendChild(button);
        }
    }
</script>
</body>
</html>

