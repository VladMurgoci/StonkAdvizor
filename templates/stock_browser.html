<!DOCTYPE html>
<html>
<head>
    <script src="{{ url_for('static', filename='jquery.js') }}"></script>
    <title>Stock Browser</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        h1 {
            text-align: center;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination button {
            margin: 5px;
        }
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            background-color: #f7f9f6;
            transition: opacity 0.75s, visibility 0.75s;
        }
        .loader-hidden{
            opacity: 0;
            visibility: hidden;
        }
        .loader::after{
            content: "";
            width: 75px;
            height: 75px;
            border: 15px solid #dddddd;
            border-top-color: #7449f5;
            border-radius: 50%;
            animation: loading 0.75s ease infinite;
        }
        @keyframes loading {
            from{
                transform: rotate(0turn);
            }
            to{
                transform: rotate(1turn);
            }
        }

    </style>
</head>
<body>
    <h1>Stock Browser</h1>
{#    <div class="loader" id="loader"></div>#}
    <table>
        <thead>
            <tr>
                <th class="text-center">Ticker</th>
                <th class="text-center">Market Cap</th>
                <th class="text-center">Net Income</th>
                <th class="text-center">Basic EPS</th>
            </tr>
        </thead>
        <tbody id="stocksTableBody">
            <!-- The data will be populated using JavaScript -->
        </tbody>
    </table>

    <div class="pagination" id="pagination">
        <!-- The pagination buttons will be populated using JavaScript -->
    </div>
<script>
    // Create a closure to preserve the value of 'i'
    function generatePaginationButtons(currentPage) {
        var paginationContainer = document.getElementById("pagination");
        paginationContainer.innerHTML = ""; // Clear existing buttons

        var totalPages = Math.ceil(ticker_list.length / 25);
        var maxPage = Math.min(currentPage + 2, totalPages);
        var start_page = Math.max(currentPage - 2, 1);
        for (var i = start_page; i <= maxPage; i++) {
            var button = document.createElement("button");
            button.innerText = i;
            button.addEventListener("click", function() {
                updateTable(i);
            });
            paginationContainer.appendChild(button);
        }
    }
    function updateTable(pageNumber) {
        var tableBody = document.getElementById("stocksTableBody");
        tableBody.innerHTML = ""; // Clear existing rows
        console.log(pageNumber);
        var itemsPerPage = 25;
        var startIndex = (pageNumber - 1) * itemsPerPage;
        var endIndex = Math.min(startIndex + itemsPerPage, ticker_list.length);

        var promises = [];
        for(var i = startIndex; i < endIndex; i++){
            var promise = $.ajax({
                url: '/stock/' + ticker_list[i],
                type: 'GET',
            })
            promises.push(promise);
        }

        Promise.all(promises).then(function(data){
            for(var i = 0; i < data.length; i++){
                var row = `<tr style="text-align:center">
                                <td>${ticker_list[i]}</td>
                                <td>${data[i]["market_cap"]}</td>
                                <td>${data[i]["net_income"]}</td>
                                <td>${data[i]["basic_eps"]}</td>
                            </tr>`;
                tableBody.innerHTML += row;
            }
        }).catch(function(error){
            console.log(error);
        });
        generatePaginationButtons(pageNumber);
    }
    var ticker_list = [];
    $.ajax({
        url: '/tickers',
        type: 'GET',
        success: function (data) {
            ticker_list = data;
            updateTable(1);
            generatePaginationButtons(1);
        },
        error: function (error) {
            console.log(error);
        },});
{#    document.getElementById("loader").style.display = "block"; // show loader#}
{#    document.ajaxStop(function() {#}
{#    const loader = document.querySelector(".loader");#}
{#    loader.classList.add("loader-hidden");#}
{#    loader.addEventListener("transitioned", () => {#}
{#        document.body.removeChild("loader");#}
{#    })#}
{# });  #}

</script>
</body>
</html>

